<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhaleSAE</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <a href="https://gallen.dev" class="back-link">&larr; Back</a>

    <h1>WhaleSAE</h1>
    <p class="subtitle">Interactive feature explorer for &ldquo;Sparse Autoencoders Reveal Interpretable Cultural Structure in Sperm Whale Communication.&rdquo;</p>
    <p class="section-desc">A sparse autoencoder learns to decompose neural network activations into individual features. This explorer lets you browse what those features respond to.</p>

    <div style="display:flex;flex-wrap:wrap;gap:0.5em;margin:1.2em 0 0.5em">
      <a href="explorer.html" class="card" style="padding:0.6em 1em;flex:1;min-width:140px;text-align:center">
        <div class="grid-card-name" style="font-size:0.9em">Feature explorer</div>
        <div class="grid-card-desc" style="margin:0">Interactive SAE feature viewer</div>
      </a>
      <a href="codas.html" class="card" style="padding:0.6em 1em;flex:1;min-width:140px;text-align:center">
        <div class="grid-card-name" style="font-size:0.9em">Coda types</div>
        <div class="grid-card-desc" style="margin:0">Browse all coda type patterns</div>
      </a>
      <a href="docs.html" class="card" style="padding:0.6em 1em;flex:1;min-width:140px;text-align:center">
        <div class="grid-card-name" style="font-size:0.9em">Guide</div>
        <div class="grid-card-desc" style="margin:0">How to read the explorer</div>
      </a>
    </div>

    <div class="hero-stats" id="hero-stats"></div>

    <div class="section-header">
      <h2>Audio SAE</h2>
      <a href="audio.html">Browse all &rarr;</a>
    </div>
    <p class="section-desc">TopK SAE (k=32) on Google Perch embeddings. Features encode click rhythms, spectral properties, and environmental conditions.</p>
    <p class="section-desc">Each feature represents a pattern the SAE discovered in whale recordings &mdash; some track click rhythms, others capture spectral signatures or recording conditions.</p>
    <div class="grid-3" id="audio-highlights"></div>

    <div class="section-header">
      <h2>CodaLM</h2>
      <span style="font-size:0.82em"><a href="explorer.html" style="color:#888;margin-right:0.8em">Explorer &rarr;</a><a href="codalm.html" style="color:#888">Grid view &rarr;</a></span>
    </div>
    <p class="section-desc">TopK SAE (k=12) on transformer hidden states. Features encode cultural structure, predictive relationships, and compositional patterns across 7 vocal clans.</p>
    <p class="section-desc">CodaLM is a small transformer trained to predict the next coda in a vocal exchange. The SAE decomposes its internal representations into features that map onto cultural and sequential structure.</p>
    <p id="codalm-type-counts" class="section-desc"></p>
    <div class="grid-3" id="codalm-highlights"></div>

    <h2 style="margin-top:1.8em;">Key results</h2>
    <div class="results-grid">
      <div class="result-card">
        <strong>96.0% classification</strong>
        <p>7-clan identification from SAE features alone (chance = 14.3%)</p>
      </div>
      <div class="result-card">
        <strong>Causal validation</strong>
        <p>Steering with 3 features achieves 100% clan assignment for 4/7 clans</p>
      </div>
      <div class="result-card">
        <strong>CKA = 0.964</strong>
        <p>Cross-equipment generalization between SAEs on different hydrophones</p>
      </div>
      <div class="result-card">
        <strong>Prediction &ne; identity</strong>
        <p>Click order matters for next-coda prediction but not clan identity</p>
      </div>
    </div>

    <hr>

    <p class="section-desc">Audio: Dominica Sperm Whale Project (DSWP). Coda sequences: Pacific Sperm Whale Research Consortium, 7 culturally-distinct vocal clans. Sparse autoencoders with TopK activation functions.</p>

    <footer><a href="https://gallen.dev">gallen.dev</a></footer>
  </div>

  <script>
  async function load() {
    var results = await Promise.all([
      fetch('data/features.json'),
      fetch('data/feature-interpretations.json'),
      fetch('data/overview.json'),
      fetch('data/codalm-features.json'),
      fetch('data/codalm-overview.json')
    ]);
    var audioFeatures = await results[0].json();
    var interps = await results[1].json();
    var audioOv = await results[2].json();
    var codalmFeatures = await results[3].json();
    var codalmOv = await results[4].json();

    // Hero stats
    document.getElementById('hero-stats').innerHTML =
      '<div class="hero-stat"><span class="hero-stat-value">' + audioOv.n_clips.toLocaleString() + '</span><span class="hero-stat-label">Audio clips</span></div>' +
      '<div class="hero-stat"><span class="hero-stat-value">' + audioOv.n_alive.toLocaleString() + '</span><span class="hero-stat-label">Audio features</span></div>' +
      '<div class="hero-stat"><span class="hero-stat-value">' + codalmOv.n_clans + '</span><span class="hero-stat-label">Vocal clans</span></div>' +
      '<div class="hero-stat"><span class="hero-stat-value">' + (codalmOv.classification.sae_accuracy * 100).toFixed(1) + '%</span><span class="hero-stat-label">Clan accuracy</span></div>';

    // Audio highlights: top firing, first novel, F2412
    var audioSorted = audioFeatures.slice().sort(function(a,b) { return b.firing_rate - a.firing_rate; });
    var novelAudio = audioFeatures.find(function(f) { return f.is_novel; });
    var f2412 = audioFeatures.find(function(f) { return f.idx === 2412; });
    var picks = [audioSorted[0], novelAudio, f2412].filter(Boolean);
    var seen = {};
    picks = picks.filter(function(f) { if (seen[f.idx]) return false; seen[f.idx] = true; return true; });

    document.getElementById('audio-highlights').innerHTML = picks.slice(0, 3).map(function(f) {
      var interp = interps[String(f.idx)] || {};
      var hyp = interp.hypothesis || f.hypothesis || '';
      var pct = (f.firing_rate * 100).toFixed(1);
      var barW = Math.min(100, f.firing_rate * 100 / 25 * 100).toFixed(0);
      return '<a href="audio-feature.html?id=' + f.idx + '" class="card">' +
        '<div class="grid-card-name">F' + f.idx + (f.is_novel ? ' <span class="badge badge-novel">novel</span>' : '') + '</div>' +
        (hyp ? '<div class="grid-card-desc">' + hyp + '</div>' : '') +
        '<div class="grid-card-meta"><span>' + pct + '% firing</span><span><strong>' + f.n_active_clips + '</strong> clips</span></div>' +
        '<div class="rate-bar"><div class="rate-bar-fill" style="width:' + barW + '%"></div></div>' +
      '</a>';
    }).join('');

    // CodaLM highlights: top firing, first clan-specific, first universal
    var codalmSorted = codalmFeatures.slice().sort(function(a,b) { return b.firing_rate - a.firing_rate; });
    var clanSpec = codalmFeatures.find(function(f) { return f.cultural_type === 'clan-specific'; });
    var univ = codalmFeatures.find(function(f) { return f.cultural_type === 'universal'; });
    var cpicks = [codalmSorted[0], clanSpec, univ].filter(Boolean);
    seen = {};
    cpicks = cpicks.filter(function(f) { if (seen[f.idx]) return false; seen[f.idx] = true; return true; });

    function cBadge(t) {
      if (t === 'universal') return '<span class="badge badge-universal">universal</span>';
      if (t === 'clan-specific') return '<span class="badge badge-clan">clan</span>';
      return '<span class="badge badge-intermediate">intermediate</span>';
    }
    function cBorder(t) {
      if (t === 'universal') return 'type-universal';
      if (t === 'clan-specific') return 'type-clan-specific';
      return 'type-intermediate';
    }

    var tc = codalmOv.cultural_type_counts;
    document.getElementById('codalm-type-counts').innerHTML =
      '<strong>' + tc.universal + '</strong> universal, <strong>' + tc['clan-specific'] + '</strong> clan-specific, <strong>' + tc.intermediate + '</strong> intermediate features';

    document.getElementById('codalm-highlights').innerHTML = cpicks.slice(0, 3).map(function(f) {
      var pct = (f.firing_rate * 100).toFixed(1);
      var barW = Math.min(100, f.firing_rate * 100 / 40 * 100).toFixed(0);
      return '<a href="codalm-feature.html?id=' + f.idx + '" class="card ' + cBorder(f.cultural_type) + '">' +
        '<div class="grid-card-name">F' + f.idx + ' ' + cBadge(f.cultural_type) + '</div>' +
        '<div class="grid-card-meta"><span>' + pct + '% firing</span><span>MI <strong>' + f.mi_bits.toFixed(3) + '</strong></span><span>Sel <strong>' + f.selectivity.toFixed(1) + '</strong></span></div>' +
        '<div class="rate-bar"><div class="rate-bar-fill" style="width:' + barW + '%"></div></div>' +
        '<div class="grid-card-meta" style="margin-top:0.2em"><span>' + f.n_active + ' active</span></div>' +
      '</a>';
    }).join('');
  }
  load();
  </script>
</body>
</html>
