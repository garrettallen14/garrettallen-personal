<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>WhaleSAE Feature Explorer</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #fff;
  --sidebar-bg: #fafafa;
  --border: #e5e7eb;
  --text: #111;
  --text-secondary: #666;
  --card-bg: #fafafa;
  --hover: #f3f4f6;
  --accent: #3b82f6;
  --radius: 8px;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  color: var(--text);
  background: var(--bg);
  line-height: 1.5;
  height: 100vh;
  overflow: hidden;
}

/* Layout */
.app {
  display: flex;
  height: 100vh;
}

/* Sidebar */
.sidebar {
  width: 300px;
  min-width: 300px;
  border-right: 1px solid var(--border);
  background: var(--sidebar-bg);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
}

.sidebar-header h1 {
  font-family: "Times New Roman", Georgia, serif;
  font-size: 1.1em;
  font-weight: 600;
  margin-bottom: 8px;
}

.sidebar-stats {
  display: flex;
  gap: 12px;
  font-size: 0.75em;
  color: var(--text-secondary);
}

.sidebar-stats span { font-weight: 600; color: var(--text); }

.sidebar-controls {
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.search-input {
  width: 100%;
  padding: 6px 10px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 0.85em;
  outline: none;
}

.search-input:focus { border-color: var(--accent); }

.filter-row {
  display: flex;
  gap: 6px;
  align-items: center;
}

.filter-row label {
  font-size: 0.75em;
  color: var(--text-secondary);
  min-width: 32px;
}

.filter-row select {
  flex: 1;
  padding: 4px 6px;
  border: 1px solid var(--border);
  border-radius: 4px;
  font-size: 0.8em;
  background: #fff;
}

.feature-list {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
}

.feature-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
  font-size: 0.82em;
  transition: background 0.1s;
}

.feature-item:hover { background: var(--hover); }
.feature-item.active { background: #e8f0fe; border-left: 3px solid var(--accent); padding-left: 13px; }

.feature-item .f-idx {
  font-weight: 600;
  min-width: 36px;
  font-variant-numeric: tabular-nums;
}

.clan-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

.feature-item .f-sel {
  margin-left: auto;
  font-variant-numeric: tabular-nums;
  color: var(--text-secondary);
  font-size: 0.9em;
}

.feature-item .f-type {
  font-size: 0.7em;
  padding: 1px 5px;
  border-radius: 3px;
  white-space: nowrap;
}

.type-clan-specific { background: #fee2e2; color: #991b1b; }
.type-universal { background: #dcfce7; color: #166534; }
.type-intermediate { background: #f3f4f6; color: #374151; }

/* Main panel */
.main-panel {
  flex: 1;
  overflow-y: auto;
  padding: 24px 32px;
}

.empty-state {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-secondary);
  font-size: 0.95em;
}

.feature-header {
  margin-bottom: 6px;
}

.feature-header h2 {
  font-family: "Times New Roman", Georgia, serif;
  font-size: 1.4em;
  font-weight: 600;
  margin-bottom: 4px;
}

.feature-header .subtitle {
  color: var(--text-secondary);
  font-size: 0.85em;
}

/* Auto interpretation */
.interpretation {
  background: #f0f7ff;
  border: 1px solid #bfdbfe;
  border-radius: var(--radius);
  padding: 12px 14px;
  margin-bottom: 20px;
  font-size: 0.85em;
  line-height: 1.6;
  color: #1e3a5f;
}

.stat-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-bottom: 24px;
}

.stat-item {
  text-align: center;
  padding: 12px 8px;
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
}

.stat-value {
  font-size: 1.25em;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
}

.stat-label {
  font-size: 0.7em;
  color: var(--text-secondary);
  margin-top: 2px;
}

.section-card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 16px;
}

.section-card h3 {
  font-size: 0.85em;
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 6px;
}

.section-desc {
  font-size: 0.75em;
  color: #999;
  margin-bottom: 10px;
  line-height: 1.4;
}

/* Tooltip */
.info-dot {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 15px;
  height: 15px;
  border-radius: 50%;
  background: #e5e7eb;
  color: #666;
  font-size: 0.7em;
  font-weight: 700;
  cursor: help;
  position: relative;
  flex-shrink: 0;
}

.info-dot .tip {
  display: none;
  position: absolute;
  bottom: calc(100% + 6px);
  left: 50%;
  transform: translateX(-50%);
  background: #1f2937;
  color: #fff;
  padding: 8px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 400;
  line-height: 1.4;
  width: 260px;
  white-space: normal;
  z-index: 100;
  pointer-events: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.info-dot .tip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 5px solid transparent;
  border-top-color: #1f2937;
}

.info-dot:hover .tip { display: block; }

/* Clan bars */
.clan-bar-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
  font-size: 0.82em;
}

.clan-bar-label {
  width: 36px;
  font-weight: 600;
  text-align: right;
  font-size: 0.8em;
}

.clan-bar-track {
  flex: 1;
  height: 18px;
  background: #f0f0f0;
  border-radius: 3px;
  overflow: hidden;
}

.clan-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.3s;
}

.clan-bar-val {
  width: 44px;
  text-align: right;
  font-variant-numeric: tabular-nums;
  font-size: 0.8em;
  color: var(--text-secondary);
}

/* Top examples */
.example-row {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid #f0f0f0;
  font-size: 0.82em;
}

.example-row:last-child { border-bottom: none; }

.example-clan {
  font-weight: 600;
  min-width: 34px;
  font-size: 0.8em;
  padding-top: 2px;
}

.example-tokens {
  flex: 1;
  display: flex;
  flex-wrap: wrap;
  gap: 3px;
}

.coda-token {
  display: inline-block;
  padding: 1px 5px;
  border-radius: 3px;
  font-size: 0.78em;
  font-weight: 500;
  white-space: nowrap;
  cursor: pointer;
  transition: opacity 0.15s, outline 0.15s;
  position: relative;
}

.coda-token:hover {
  outline: 2px solid rgba(59,130,246,0.6);
  outline-offset: 1px;
  z-index: 2;
}

/* Token tooltip */
.token-tip {
  display: none;
  position: absolute;
  bottom: calc(100% + 6px);
  left: 50%;
  transform: translateX(-50%);
  background: #1f2937;
  color: #fff;
  padding: 6px 9px;
  border-radius: 5px;
  font-size: 11px;
  font-weight: 400;
  line-height: 1.4;
  width: max-content;
  max-width: 220px;
  white-space: normal;
  z-index: 100;
  pointer-events: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.token-tip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 4px solid transparent;
  border-top-color: #1f2937;
}

.coda-token:hover .token-tip { display: block; }

.example-act {
  min-width: 40px;
  text-align: right;
  font-variant-numeric: tabular-nums;
  font-weight: 600;
  color: var(--text-secondary);
  padding-top: 2px;
}

.show-more-btn {
  display: block;
  width: 100%;
  padding: 6px;
  margin-top: 8px;
  background: none;
  border: 1px solid var(--border);
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.8em;
  color: var(--text-secondary);
}

.show-more-btn:hover { background: var(--hover); }

/* Logit lens */
.logit-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.logit-col h4 {
  font-size: 0.78em;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text-secondary);
}

.logit-item {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
  font-size: 0.8em;
  cursor: pointer;
  border-radius: 3px;
  padding: 2px 4px;
  margin-left: -4px;
}

.logit-item:hover { background: #f0f0f0; }

.logit-bar {
  width: 48px;
  height: 12px;
  border-radius: 2px;
}

.logit-type { font-weight: 500; min-width: 60px; }
.logit-val { color: var(--text-secondary); font-variant-numeric: tabular-nums; font-size: 0.9em; }

/* Co-firing */
.cofiring-item {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  margin: 0 6px 6px 0;
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 0.82em;
  cursor: pointer;
  transition: background 0.1s;
}

.cofiring-item:hover { background: var(--hover); }

.cofiring-rate {
  color: var(--text-secondary);
  font-variant-numeric: tabular-nums;
}

/* Histogram */
#histogramCanvas {
  max-height: 140px;
}

/* Reverse lookup panel */
.reverse-panel {
  background: #fffbeb;
  border: 1px solid #fde68a;
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 16px;
}

.reverse-panel h3 {
  font-size: 0.85em;
  font-weight: 600;
  color: #92400e;
  margin-bottom: 8px;
}

.reverse-panel .reverse-desc {
  font-size: 0.75em;
  color: #a16207;
  margin-bottom: 8px;
}

.reverse-results {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

.reverse-chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  background: #fff;
  border: 1px solid #fde68a;
  border-radius: 4px;
  font-size: 0.78em;
  cursor: pointer;
  transition: background 0.1s;
}

.reverse-chip:hover { background: #fef3c7; }

.reverse-chip .rv-act {
  color: #a16207;
  font-variant-numeric: tabular-nums;
}

.reverse-close {
  float: right;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1em;
  color: #a16207;
  padding: 0 4px;
}

.reverse-close:hover { color: #92400e; }

/* Keyboard hint */
.kbd-hint {
  font-size: 0.7em;
  color: #aaa;
  text-align: center;
  padding: 6px;
  border-top: 1px solid #f0f0f0;
}

kbd {
  display: inline-block;
  padding: 1px 5px;
  background: #f3f4f6;
  border: 1px solid #d1d5db;
  border-radius: 3px;
  font-family: inherit;
  font-size: 0.95em;
}

/* Responsive */
@media (max-width: 768px) {
  .sidebar { width: 240px; min-width: 240px; }
  .main-panel { padding: 16px; }
  .stat-grid { grid-template-columns: repeat(2, 1fr); }
  .logit-grid { grid-template-columns: 1fr; }
}

@media (max-width: 560px) {
  .app { flex-direction: column; }
  .sidebar {
    width: 100%;
    min-width: 100%;
    max-height: 40vh;
    border-right: none;
    border-bottom: 1px solid var(--border);
  }
  .main-panel { height: 60vh; }
}
</style>
</head>
<body>
<div class="app">
  <div class="sidebar">
    <div class="sidebar-header">
      <div style="display:flex;gap:8px;margin-bottom:6px;font-size:0.75em">
        <a href="docs.html" style="color:#888;text-decoration:none;border:none">Guide</a>
        <a href="codas.html" style="color:#888;text-decoration:none;border:none">Coda types</a>
        <a href="about.html" style="color:#888;text-decoration:none;border:none">About</a>
        <a href="codalm.html" style="color:#888;text-decoration:none;border:none">Grid view</a>
      </div>
      <h1>WhaleSAE Feature Explorer</h1>
      <div class="sidebar-stats">
        <div><span id="aliveCount">-</span> alive</div>
        <div><span id="windowCount">-</span> windows</div>
        <div><span id="totalCount">512</span> total</div>
      </div>
    </div>
    <div class="sidebar-controls">
      <input class="search-input" id="searchInput" type="text" placeholder="Search by index, clan, or coda type...">
      <div class="filter-row">
        <label>Sort</label>
        <select id="sortSelect">
          <option value="selectivity">Selectivity</option>
          <option value="firing_rate">Firing rate</option>
          <option value="idx">Index</option>
        </select>
      </div>
      <div class="filter-row">
        <label>Clan</label>
        <select id="clanFilter">
          <option value="all">All clans</option>
        </select>
      </div>
      <div class="filter-row">
        <label>Type</label>
        <select id="typeFilter">
          <option value="all">All types</option>
          <option value="clan-specific">Clan-specific</option>
          <option value="universal">Universal</option>
          <option value="intermediate">Intermediate</option>
        </select>
      </div>
    </div>
    <div class="feature-list" id="featureList"></div>
    <div class="kbd-hint"><kbd>&uarr;</kbd> <kbd>&darr;</kbd> to browse features</div>
  </div>

  <div class="main-panel" id="mainPanel">
    <div class="empty-state" id="emptyState">Select a feature from the sidebar</div>
    <div id="featureDetail" style="display:none">
      <div class="feature-header">
        <h2 id="featureTitle"></h2>
        <div class="subtitle" id="featureSubtitle"></div>
      </div>

      <div class="interpretation" id="interpretation"></div>

      <div class="stat-grid" id="statGrid"></div>

      <div id="reversePanel" style="display:none"></div>

      <div class="section-card">
        <h3>Clan activation <span class="info-dot">?<span class="tip">Mean activation of this feature across windows from each of the 7 sperm whale clans. A clan-specific feature fires strongly for one clan and near-zero for others.</span></span></h3>
        <div class="section-desc">How strongly this feature fires for each clan's coda sequences</div>
        <div id="clanBars"></div>
      </div>

      <div class="section-card">
        <h3>Top activating windows <span class="info-dot">?<span class="tip">The 20 coda sequences that activate this feature most strongly. Each colored token is a coda type. Brightness = relevance: vivid tokens contribute most to this feature's activation, faded tokens contribute less. Click any token to see which other features respond to it.</span></span></h3>
        <div class="section-desc">Coda sequences where this feature fires strongest. Brighter tokens matter more.</div>
        <div id="topExamples"></div>
      </div>

      <div class="section-card">
        <h3>Logit lens <span class="info-dot">?<span class="tip">What this feature does to next-token prediction. "Promotes" means the feature pushes the model toward predicting these coda types next. "Suppresses" means it pushes away from them. Computed by projecting the feature's decoder direction through the output head.</span></span></h3>
        <div class="section-desc">Which coda types this feature promotes or suppresses in next-token prediction</div>
        <div class="logit-grid" id="logitLens"></div>
      </div>

      <div class="section-card">
        <h3>Co-firing features <span class="info-dot">?<span class="tip">Features that tend to activate alongside this one. High co-firing rate means these features frequently fire on the same windows, suggesting they encode related or complementary information.</span></span></h3>
        <div class="section-desc">Other features that tend to activate on the same windows</div>
        <div id="cofiring"></div>
      </div>

      <div class="section-card">
        <h3>Activation distribution <span class="info-dot">?<span class="tip">Histogram of this feature's nonzero activation values. A tight distribution means the feature fires at a consistent strength. A wide distribution means it fires at varying intensities, possibly encoding graded information.</span></span></h3>
        <div class="section-desc">Distribution of nonzero activation magnitudes</div>
        <canvas id="histogramCanvas"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
let DATA = null;
let selectedIdx = null;
let histChart = null;
let filteredList = [];

// Deterministic color from coda type string (HSL)
function codaColor(type) {
  let h = 0;
  for (let i = 0; i < type.length; i++) {
    h = ((h << 5) - h + type.charCodeAt(i)) | 0;
  }
  h = ((h % 360) + 360) % 360;
  return { h, bg: `hsl(${h}, 55%, 88%)`, fg: `hsl(${h}, 50%, 28%)` };
}

// Auto-generate a plain-English interpretation
function autoInterpret(f) {
  const parts = [];

  // Type description
  if (f.type === 'clan-specific') {
    parts.push(`This feature fires almost exclusively for ${f.dominant_clan} clan sequences (selectivity ${f.selectivity.toFixed(2)}).`);
  } else if (f.type === 'universal') {
    parts.push(`This feature fires across all clans with no strong preference (selectivity ${f.selectivity.toFixed(2)}).`);
  } else {
    parts.push(`This feature fires preferentially for ${f.dominant_clan} clan but also responds to other clans (selectivity ${f.selectivity.toFixed(2)}).`);
  }

  // Firing rate
  const pct = (f.firing_rate * 100).toFixed(1);
  if (f.firing_rate > 0.3) {
    parts.push(`It activates frequently (${pct}% of windows).`);
  } else if (f.firing_rate > 0.05) {
    parts.push(`It activates on ${pct}% of windows.`);
  } else {
    parts.push(`It fires rarely (${pct}% of windows), suggesting a highly specific trigger.`);
  }

  // Logit lens summary
  const ll = f.logit_lens || { promoted: [], suppressed: [] };
  if (ll.promoted.length > 0 && ll.suppressed.length > 0) {
    const topP = ll.promoted.slice(0, 2).map(x => x.type).join(', ');
    const topS = ll.suppressed.slice(0, 2).map(x => x.type).join(', ');
    parts.push(`It promotes coda types ${topP} and suppresses ${topS} in next-token prediction.`);
  }

  // Top example clan consistency
  const exClans = (f.top_examples || []).map(e => e.clan);
  const uniqueClans = [...new Set(exClans)];
  if (uniqueClans.length === 1) {
    parts.push(`All top-activating windows come from ${uniqueClans[0]} clan.`);
  } else if (uniqueClans.length <= 3) {
    parts.push(`Top windows span ${uniqueClans.length} clans: ${uniqueClans.join(', ')}.`);
  }

  return parts.join(' ');
}

// Build reverse lookup index: coda_type -> [{feature_idx, mean_logit_effect}]
let reverseIndex = null;
function buildReverseIndex() {
  reverseIndex = {};
  DATA.features.forEach(f => {
    if (!f.alive) return;
    const ll = f.logit_lens || { promoted: [], suppressed: [] };
    ll.promoted.forEach(item => {
      if (!reverseIndex[item.type]) reverseIndex[item.type] = [];
      reverseIndex[item.type].push({ idx: f.idx, effect: item.effect, dominant_clan: f.dominant_clan });
    });
    ll.suppressed.forEach(item => {
      if (!reverseIndex[item.type]) reverseIndex[item.type] = [];
      reverseIndex[item.type].push({ idx: f.idx, effect: item.effect, dominant_clan: f.dominant_clan });
    });
  });
  // Sort each by absolute effect
  Object.values(reverseIndex).forEach(arr => arr.sort((a, b) => Math.abs(b.effect) - Math.abs(a.effect)));
}

function showReverseLookup(codaType) {
  if (!reverseIndex) buildReverseIndex();
  const matches = reverseIndex[codaType] || [];
  const panel = document.getElementById('reversePanel');
  if (matches.length === 0) {
    panel.style.display = 'none';
    return;
  }

  const colors = DATA.meta.clan_colors;
  const top = matches.slice(0, 20);
  panel.style.display = 'block';
  panel.innerHTML = `
    <div class="reverse-panel">
      <button class="reverse-close" onclick="document.getElementById('reversePanel').style.display='none'">&times;</button>
      <h3>Features responding to coda type "${codaType}"</h3>
      <div class="reverse-desc">${matches.length} features have this coda type in their logit lens. Sorted by effect magnitude.</div>
      <div class="reverse-results">
        ${top.map(m => `
          <span class="reverse-chip" onclick="selectFeature(${m.idx})">
            <span class="clan-dot" style="background:${colors[m.dominant_clan] || '#888'};width:8px;height:8px;border-radius:50%;display:inline-block"></span>
            F${m.idx}
            <span class="rv-act">${m.effect > 0 ? '+' : ''}${m.effect.toFixed(2)}</span>
          </span>
        `).join('')}
      </div>
    </div>
  `;
  // Scroll to make it visible
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

async function init() {
  const resp = await fetch('data/data.json');
  DATA = await resp.json();

  document.getElementById('aliveCount').textContent = DATA.meta.n_alive;
  document.getElementById('windowCount').textContent = DATA.meta.n_windows.toLocaleString();
  document.getElementById('totalCount').textContent = DATA.meta.n_features;

  // Populate clan filter
  const clanSel = document.getElementById('clanFilter');
  DATA.meta.clan_names.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    clanSel.appendChild(opt);
  });

  // Build reverse index
  buildReverseIndex();

  // Event listeners
  document.getElementById('searchInput').addEventListener('input', renderList);
  document.getElementById('sortSelect').addEventListener('change', renderList);
  document.getElementById('clanFilter').addEventListener('change', renderList);
  document.getElementById('typeFilter').addEventListener('change', renderList);

  // Keyboard navigation
  document.addEventListener('keydown', handleKeyNav);

  renderList();

  // Check URL hash for deep link
  const hash = window.location.hash;
  if (hash && hash.match(/^#F?\d+$/i)) {
    const idx = parseInt(hash.replace(/^#F?/i, ''));
    if (DATA.features[idx] && DATA.features[idx].alive) {
      selectFeature(idx);
      return;
    }
  }

  // Auto-select first alive feature
  if (filteredList.length > 0) selectFeature(filteredList[0].idx);
}

function handleKeyNav(e) {
  if (!DATA || filteredList.length === 0) return;
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

  if (e.key === 'ArrowDown' || e.key === 'j') {
    e.preventDefault();
    const curPos = filteredList.findIndex(f => f.idx === selectedIdx);
    const next = Math.min(curPos + 1, filteredList.length - 1);
    selectFeature(filteredList[next].idx);
    scrollFeatureIntoView(filteredList[next].idx);
  } else if (e.key === 'ArrowUp' || e.key === 'k') {
    e.preventDefault();
    const curPos = filteredList.findIndex(f => f.idx === selectedIdx);
    const prev = Math.max(curPos - 1, 0);
    selectFeature(filteredList[prev].idx);
    scrollFeatureIntoView(filteredList[prev].idx);
  }
}

function scrollFeatureIntoView(idx) {
  const el = document.querySelector(`.feature-item[data-idx="${idx}"]`);
  if (el) el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
}

function getFilteredFeatures() {
  const search = document.getElementById('searchInput').value.toLowerCase().trim();
  const sortBy = document.getElementById('sortSelect').value;
  const clanFilter = document.getElementById('clanFilter').value;
  const typeFilter = document.getElementById('typeFilter').value;

  let list = DATA.features.filter(f => f.alive);

  if (search) {
    list = list.filter(f => {
      // Match by feature index
      if (String(f.idx).includes(search)) return true;
      // Match by clan name
      if (f.dominant_clan.toLowerCase().includes(search)) return true;
      // Match by type
      if (f.type.toLowerCase().includes(search)) return true;
      // Match by coda type in logit lens
      const ll = f.logit_lens || { promoted: [], suppressed: [] };
      const allTypes = [...ll.promoted, ...ll.suppressed].map(x => x.type.toLowerCase());
      if (allTypes.some(t => t.includes(search))) return true;
      return false;
    });
  }

  if (clanFilter !== 'all') {
    list = list.filter(f => f.dominant_clan === clanFilter);
  }

  if (typeFilter !== 'all') {
    list = list.filter(f => f.type === typeFilter);
  }

  list.sort((a, b) => {
    if (sortBy === 'selectivity') return b.selectivity - a.selectivity;
    if (sortBy === 'firing_rate') return b.firing_rate - a.firing_rate;
    return a.idx - b.idx;
  });

  return list;
}

function renderList() {
  filteredList = getFilteredFeatures();
  const container = document.getElementById('featureList');
  const colors = DATA.meta.clan_colors;

  container.innerHTML = filteredList.map(f => `
    <div class="feature-item ${f.idx === selectedIdx ? 'active' : ''}"
         onclick="selectFeature(${f.idx})" data-idx="${f.idx}">
      <span class="f-idx">F${f.idx}</span>
      <span class="clan-dot" style="background:${colors[f.dominant_clan] || '#888'}"></span>
      <span class="f-type type-${f.type}">${f.type}</span>
      <span class="f-sel">${f.selectivity.toFixed(2)}</span>
    </div>
  `).join('');
}

function selectFeature(idx) {
  selectedIdx = idx;
  const f = DATA.features[idx];
  if (!f || !f.alive) return;

  // Update URL hash
  history.replaceState(null, '', `#F${idx}`);

  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('featureDetail').style.display = 'block';

  // Update active state in sidebar
  document.querySelectorAll('.feature-item').forEach(el => {
    el.classList.toggle('active', Number(el.dataset.idx) === idx);
  });

  // Hide reverse panel on feature switch
  document.getElementById('reversePanel').style.display = 'none';

  // Scroll main panel to top
  document.getElementById('mainPanel').scrollTop = 0;

  renderFeature(f);
}

function renderFeature(f) {
  const colors = DATA.meta.clan_colors;

  // Header
  document.getElementById('featureTitle').textContent = `Feature F${f.idx}`;
  document.getElementById('featureSubtitle').textContent =
    `${f.type} | dominant: ${f.dominant_clan} | firing rate: ${(f.firing_rate * 100).toFixed(1)}%`;

  // Auto interpretation
  document.getElementById('interpretation').textContent = autoInterpret(f);

  // Stats
  document.getElementById('statGrid').innerHTML = [
    { v: f.selectivity.toFixed(2), l: 'Selectivity', tip: 'Fraction of total activation from the dominant clan. 1.0 = fires only for one clan.' },
    { v: (f.firing_rate * 100).toFixed(1) + '%', l: 'Firing rate', tip: 'Percentage of input windows where this feature activates (nonzero).' },
    { v: f.dominant_clan, l: 'Dominant clan', tip: 'The clan with the highest mean activation for this feature.' },
    { v: f.type, l: 'Type', tip: 'Clan-specific (1-2 clans), intermediate (3-4), or universal (5+).' },
  ].map(s => `
    <div class="stat-item" title="${s.tip}">
      <div class="stat-value">${s.v}</div>
      <div class="stat-label">${s.l}</div>
    </div>
  `).join('');

  // Clan bars
  const maxClan = Math.max(...Object.values(f.clan_means));
  document.getElementById('clanBars').innerHTML = DATA.meta.clan_names.map(c => {
    const val = f.clan_means[c] || 0;
    const pct = maxClan > 0 ? (val / maxClan * 100) : 0;
    return `
      <div class="clan-bar-row">
        <span class="clan-bar-label">${c}</span>
        <div class="clan-bar-track">
          <div class="clan-bar-fill" style="width:${pct}%;background:${colors[c] || '#888'}"></div>
        </div>
        <span class="clan-bar-val">${val.toFixed(3)}</span>
      </div>
    `;
  }).join('');

  // Top examples
  renderExamples(f);

  // Logit lens
  renderLogitLens(f);

  // Co-firing
  renderCofiring(f);

  // Histogram
  renderHistogram(f);
}

function renderExamples(f) {
  const container = document.getElementById('topExamples');
  const colors = DATA.meta.clan_colors;
  const show = 8;
  const examples = f.top_examples || [];

  function exampleHTML(ex) {
    const tokens = ex.types.map((t, i) => {
      const c = codaColor(t);
      const rel = ex.relevance[i] || 0;
      const opacity = 0.3 + 0.7 * rel;
      const relPct = (rel * 100).toFixed(0);
      return `<span class="coda-token" style="background:${c.bg};color:${c.fg};opacity:${opacity.toFixed(2)}" onclick="event.stopPropagation();showReverseLookup('${t}')"><span class="token-tip">Coda type: ${t}<br>Relevance: ${relPct}%<br>Click to find features</span>${t}</span>`;
    }).join('');
    return `
      <div class="example-row">
        <span class="example-clan" style="color:${colors[ex.clan] || '#888'}">${ex.clan}</span>
        <div class="example-tokens">${tokens}</div>
        <span class="example-act">${ex.activation.toFixed(2)}</span>
      </div>
    `;
  }

  let html = examples.slice(0, show).map(exampleHTML).join('');
  if (examples.length > show) {
    html += `<button class="show-more-btn" id="showMoreBtn">Show ${examples.length - show} more</button>`;
  }
  container.innerHTML = html;

  if (examples.length > show) {
    document.getElementById('showMoreBtn').onclick = () => {
      container.innerHTML = examples.map(exampleHTML).join('');
    };
  }
}

function renderLogitLens(f) {
  const ll = f.logit_lens || { promoted: [], suppressed: [] };
  const maxP = Math.max(...ll.promoted.map(x => Math.abs(x.effect)), 0.01);
  const maxS = Math.max(...ll.suppressed.map(x => Math.abs(x.effect)), 0.01);

  function renderCol(items, maxVal, color) {
    return items.map(item => {
      const pct = Math.min(Math.abs(item.effect) / maxVal * 100, 100);
      return `
        <div class="logit-item" onclick="showReverseLookup('${item.type}')" title="Click to see features responding to ${item.type}">
          <span class="logit-type">${item.type}</span>
          <div class="logit-bar" style="width:${pct}%;background:${color}"></div>
          <span class="logit-val">${item.effect > 0 ? '+' : ''}${item.effect.toFixed(2)}</span>
        </div>
      `;
    }).join('');
  }

  document.getElementById('logitLens').innerHTML = `
    <div class="logit-col">
      <h4>Promotes</h4>
      ${renderCol(ll.promoted, maxP, 'rgba(34,197,94,0.5)')}
    </div>
    <div class="logit-col">
      <h4>Suppresses</h4>
      ${renderCol(ll.suppressed, maxS, 'rgba(239,68,68,0.5)')}
    </div>
  `;
}

function renderCofiring(f) {
  const colors = DATA.meta.clan_colors;
  const items = f.cofiring || [];
  if (items.length === 0) {
    document.getElementById('cofiring').innerHTML = '<span style="color:var(--text-secondary);font-size:0.85em">No co-firing features</span>';
    return;
  }

  document.getElementById('cofiring').innerHTML = items.map(cf => `
    <span class="cofiring-item" onclick="selectFeature(${cf.idx})">
      <span class="clan-dot" style="background:${colors[cf.dominant_clan] || '#888'}"></span>
      F${cf.idx}
      <span class="cofiring-rate">${(cf.rate * 100).toFixed(0)}%</span>
    </span>
  `).join('');
}

function renderHistogram(f) {
  const hist = f.histogram || { edges: [], counts: [] };
  if (hist.edges.length === 0) return;

  const labels = hist.counts.map((_, i) => {
    const lo = hist.edges[i].toFixed(1);
    const hi = hist.edges[i + 1].toFixed(1);
    return `${lo}-${hi}`;
  });

  const canvas = document.getElementById('histogramCanvas');
  if (histChart) histChart.destroy();

  histChart = new Chart(canvas, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data: hist.counts,
        backgroundColor: 'rgba(59,130,246,0.45)',
        borderColor: 'rgba(59,130,246,0.7)',
        borderWidth: 1,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: {
          display: true,
          ticks: { maxRotation: 45, font: { size: 10 }, maxTicksLimit: 10 },
          grid: { display: false },
        },
        y: {
          display: true,
          ticks: { font: { size: 10 } },
          grid: { color: '#f0f0f0' },
        }
      }
    }
  });
}

init();
</script>
</body>
</html>
