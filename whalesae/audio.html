<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio SAE Features - WhaleSAE</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <a href="index.html" class="back-link">&larr; Back</a>
    <h1>Audio SAE Features</h1>
    <p class="section-desc">TopK SAE (k=32) on Google Perch embeddings of 1,501 sperm whale recordings.</p>
    <p class="section-desc">Each card is one learned feature from a sparse autoencoder trained on Perch audio embeddings. Firing rate is the percentage of recordings that activate this feature. Features marked "novel" have no strong correlation with any measured acoustic property.</p>
    <p id="stats-line" class="stats"></p>

    <div class="controls">
      <label>Sort by <select id="sort-select">
        <option value="firing_rate">Firing rate</option>
        <option value="n_active_clips">Active clips</option>
        <option value="idx">Feature index</option>
      </select></label>
      <label>Type <select id="type-select">
        <option value="all">All</option>
        <option value="novel">Novel</option>
        <option value="well-characterized">Well-characterized</option>
        <option value="partially-characterized">Partially-characterized</option>
        <option value="complex">Complex</option>
      </select></label>
      <label>Order <select id="order-select">
        <option value="desc">Descending</option>
        <option value="asc">Ascending</option>
      </select></label>
    </div>
    <p class="muted" style="margin-top:0.3em;">Firing rate = % of clips activating &middot; Clips = number of recordings where this feature is active</p>

    <p id="showing-count" class="showing-count"></p>
    <div id="feature-list" class="grid-3"></div>
    <div id="load-more-wrap" style="text-align:center; margin-top:1em; display:none;">
      <button id="load-more-btn" class="load-more-btn">Show more</button>
    </div>

    <footer>WhaleSAE &middot; Sparse Autoencoders for Sperm Whale Communication</footer>
  </div>

  <script>
  var allFeatures = [];
  var interpretations = {};
  var displayCount = 42;

  function getFiltered() {
    var feats = allFeatures.slice();
    var typeFilter = document.getElementById('type-select').value;
    if (typeFilter !== 'all') {
      feats = feats.filter(function(f) {
        var cat = interpretations[f.idx] ? interpretations[f.idx].category : f.category;
        return cat === typeFilter;
      });
    }
    var sortKey = document.getElementById('sort-select').value;
    var desc = document.getElementById('order-select').value === 'desc';
    feats.sort(function(a, b) {
      return desc ? (b[sortKey] || 0) - (a[sortKey] || 0) : (a[sortKey] || 0) - (b[sortKey] || 0);
    });
    return feats;
  }

  function truncate(t, m) { return !t ? '' : t.length > m ? t.slice(0, m) + '...' : t; }

  function renderCard(f) {
    var interp = interpretations[f.idx] || {};
    var hyp = interp.hypothesis || f.hypothesis || '';
    var isNovel = f.is_novel || (interp.category === 'novel');
    var pct = (f.firing_rate * 100).toFixed(1);
    var barW = Math.min(100, f.firing_rate * 100 / 25 * 100).toFixed(0);
    return '<a href="audio-feature.html?id=' + f.idx + '" class="card">' +
      '<div class="grid-card-name">F' + f.idx +
        (isNovel ? ' <span class="badge badge-novel">novel</span>' : '') + '</div>' +
      (hyp ? '<div class="grid-card-desc">' + truncate(hyp, 80) + '</div>' : '') +
      '<div class="grid-card-meta"><span>' + pct + '%</span><span><strong>' + f.n_active_clips + '</strong> clips</span></div>' +
      '<div class="rate-bar"><div class="rate-bar-fill" style="width:' + barW + '%"></div></div>' +
    '</a>';
  }

  function render() {
    var filtered = getFiltered();
    var showing = filtered.slice(0, displayCount);
    document.getElementById('showing-count').textContent =
      'Showing ' + showing.length + ' of ' + filtered.length;
    document.getElementById('feature-list').innerHTML = showing.map(renderCard).join('');
    document.getElementById('load-more-wrap').style.display =
      displayCount < filtered.length ? '' : 'none';
  }

  async function load() {
    var results = await Promise.all([
      fetch('data/features.json'),
      fetch('data/overview.json'),
      fetch('data/feature-interpretations.json')
    ]);
    allFeatures = await results[0].json();
    var ov = await results[1].json();
    interpretations = await results[2].json();

    document.getElementById('stats-line').innerHTML =
      '<strong>' + ov.n_alive.toLocaleString() + '</strong> alive features &middot; ' +
      '<strong>' + ov.n_clips.toLocaleString() + '</strong> recordings &middot; ' +
      '<strong>' + ov.n_ceti_matched + '</strong> CETI-matched &middot; ' +
      '<strong>' + ov.n_novel + '</strong> novel';
    render();
  }

  document.getElementById('sort-select').addEventListener('change', function() { displayCount = 42; render(); });
  document.getElementById('type-select').addEventListener('change', function() { displayCount = 42; render(); });
  document.getElementById('order-select').addEventListener('change', function() { displayCount = 42; render(); });
  document.getElementById('load-more-btn').addEventListener('click', function() { displayCount += 42; render(); });
  load();
  </script>
</body>
</html>
