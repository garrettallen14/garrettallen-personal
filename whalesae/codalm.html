<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CodaLM Features - WhaleSAE</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <a href="index.html" class="back-link">&larr; Back</a>
    <h1>CodaLM Features</h1>
    <p class="section-desc">TopK SAE (k=12) on SimpleWhaleLM hidden states. Each feature encodes a pattern in how codas are ordered within vocal exchanges.</p>
    <p class="section-desc">Each card is one feature from a sparse autoencoder trained on CodaLM's hidden states. Features organize into three populations: cultural markers (encode clan identity), predictive detectors (track sequential patterns), and compositional features (respond to individual coda types).</p>
    <p id="stats-line" class="stats"></p>

    <h3>Clans</h3>
    <p class="section-desc" style="margin-top:0;">The seven Pacific vocal clans, each with distinct coda repertoires:</p>
    <div id="clan-list" class="clan-list"></div>

    <div class="controls">
      <label>Sort by <select id="sort-select">
        <option value="firing_rate">Firing rate</option>
        <option value="mi_bits">MI</option>
        <option value="selectivity">Selectivity</option>
        <option value="idx">Feature index</option>
      </select></label>
      <label>Type <select id="type-select">
        <option value="all">All</option>
        <option value="universal">Universal</option>
        <option value="clan-specific">Clan-specific</option>
        <option value="intermediate">Intermediate</option>
      </select></label>
      <label>Order <select id="order-select">
        <option value="desc">Descending</option>
        <option value="asc">Ascending</option>
      </select></label>
    </div>
    <p class="muted" style="margin-top:0.3em;">MI = mutual information with clan labels (bits) &middot; Sel = selectivity (how concentrated firing is across clans) &middot; Active = number of examples where feature fires</p>

    <p id="showing-count" class="showing-count"></p>
    <div id="feature-list" class="grid-3"></div>
    <div id="load-more-wrap" style="text-align:center; margin-top:1em; display:none;">
      <button id="load-more-btn" class="load-more-btn">Show more</button>
    </div>

    <footer>WhaleSAE &middot; Sparse Autoencoders for Sperm Whale Communication</footer>
  </div>

  <script>
  var allFeatures = [];
  var displayCount = 42;

  function badgeHtml(t) {
    if (t === 'universal') return '<span class="badge badge-universal">universal</span>';
    if (t === 'clan-specific') return '<span class="badge badge-clan">clan</span>';
    return '<span class="badge badge-intermediate">intermediate</span>';
  }
  function typeClass(t) {
    if (t === 'universal') return 'type-universal';
    if (t === 'clan-specific') return 'type-clan-specific';
    return 'type-intermediate';
  }

  function getFiltered() {
    var feats = allFeatures.slice();
    var tf = document.getElementById('type-select').value;
    if (tf !== 'all') feats = feats.filter(function(f) { return f.cultural_type === tf; });
    var sk = document.getElementById('sort-select').value;
    var desc = document.getElementById('order-select').value === 'desc';
    feats.sort(function(a, b) { return desc ? (b[sk]||0)-(a[sk]||0) : (a[sk]||0)-(b[sk]||0); });
    return feats;
  }

  function renderCard(f) {
    var pct = (f.firing_rate * 100).toFixed(1);
    var barW = Math.min(100, f.firing_rate * 100 / 40 * 100).toFixed(0);
    return '<a href="codalm-feature.html?id=' + f.idx + '" class="card ' + typeClass(f.cultural_type) + '">' +
      '<div class="grid-card-name">F' + f.idx + ' ' + badgeHtml(f.cultural_type) + '</div>' +
      '<div class="grid-card-meta">' +
        '<span>' + pct + '%</span>' +
        '<span>MI <strong>' + f.mi_bits.toFixed(3) + '</strong></span>' +
        '<span>Sel <strong>' + f.selectivity.toFixed(1) + '</strong></span>' +
      '</div>' +
      '<div class="rate-bar"><div class="rate-bar-fill" style="width:' + barW + '%"></div></div>' +
      '<div class="grid-card-meta" style="margin-top:0.2em"><span>' + f.n_active + ' active</span></div>' +
    '</a>';
  }

  function render() {
    var filtered = getFiltered();
    var showing = filtered.slice(0, displayCount);
    document.getElementById('showing-count').textContent =
      'Showing ' + showing.length + ' of ' + filtered.length;
    document.getElementById('feature-list').innerHTML = showing.map(renderCard).join('');
    document.getElementById('load-more-wrap').style.display =
      displayCount < filtered.length ? '' : 'none';
  }

  async function load() {
    var results = await Promise.all([
      fetch('data/codalm-features.json'),
      fetch('data/codalm-overview.json'),
      fetch('data/codalm-clans.json')
    ]);
    allFeatures = await results[0].json();
    var ov = await results[1].json();
    var clans = await results[2].json();

    document.getElementById('stats-line').innerHTML =
      '<strong>' + ov.n_alive + '</strong> alive &middot; ' +
      '<strong>' + ov.n_examples.toLocaleString() + '</strong> examples &middot; ' +
      (ov.classification.sae_accuracy * 100).toFixed(1) + '% accuracy &middot; ' +
      ov.cultural_type_counts.universal + ' universal &middot; ' +
      ov.cultural_type_counts['clan-specific'] + ' clan-specific &middot; ' +
      ov.cultural_type_counts.intermediate + ' intermediate';

    document.getElementById('clan-list').innerHTML = ov.clan_names.map(function(name) {
      var c = clans[name] || {};
      return '<span class="clan-chip">' +
        '<strong>' + name + '</strong> <span class="clan-count">' + (c.n_examples || 0) + '</span></span>';
    }).join('');
    render();
  }

  document.getElementById('sort-select').addEventListener('change', function() { displayCount = 42; render(); });
  document.getElementById('type-select').addEventListener('change', function() { displayCount = 42; render(); });
  document.getElementById('order-select').addEventListener('change', function() { displayCount = 42; render(); });
  document.getElementById('load-more-btn').addEventListener('click', function() { displayCount += 42; render(); });
  load();
  </script>
</body>
</html>
