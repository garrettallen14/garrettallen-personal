<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clip Detail - WhaleSAE</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="top-nav">
    <a href="index.html" class="nav-brand">WhaleSAE</a>
    <div class="nav-links">
      <a href="index.html">Overview</a>
      <a href="clips.html" class="active">Clips</a>
      <a href="features.html">Audio</a>
      <a href="whalelm.html">WhaleLM</a>
      <a href="about.html">About</a>
    </div>
  </nav>
  <main class="container">
    <div class="breadcrumb"><a href="clips.html">Audio clips</a> / <span id="crumb-name">Clip</span></div>
    <h1 id="clip-title">Loading...</h1>

    <div id="clip-player-main" class="card">
      <audio controls preload="auto" style="width:100%">
        <source src="" type="audio/wav">
      </audio>
    </div>

    <div id="clip-meta" class="stats-bar"></div>

    <div id="ceti-card" class="card" style="display:none;">
      <h2 id="ceti-heading"></h2>
      <p id="ceti-desc" class="card-desc"></p>
      <div id="ceti-props" class="props-grid"></div>
    </div>

    <div id="recording-card" class="card">
      <h2>Recording properties</h2>
      <p class="card-desc">Acoustic properties detected from the raw audio waveform.</p>
      <div id="recording-props" class="props-grid"></div>
    </div>

    <div id="warnings-card" class="card" style="display:none;">
      <h2>Quality flags</h2>
      <div id="warnings-list"></div>
    </div>

    <div class="card">
      <h2 id="features-heading">Active SAE features</h2>
      <p class="card-desc">All features the audio SAE detects in this clip, ranked by activation strength.</p>
      <div id="features-list" class="clips-list"></div>
    </div>

    <div id="nearby-card" class="card" style="display:none;">
      <h2>Nearby clips (same session group)</h2>
      <p class="card-desc">Other recordings from approximately the same recording session.</p>
      <div id="nearby-list" class="clips-list"></div>
    </div>
  </main>

  <script>
  const clipIdx = parseInt(new URLSearchParams(window.location.search).get('id'));

  async function load() {
    const [clipsRes, actsRes, interpsRes] = await Promise.all([
      fetch('data/clips.json'),
      fetch('data/clip-activations.json'),
      fetch('data/feature-interpretations.json')
    ]);
    const allClips = await clipsRes.json();
    const allActivations = await actsRes.json();
    const interps = await interpsRes.json();

    // Also load feature stats for firing rates
    const featRes = await fetch('data/features.json');
    const allFeatures = await featRes.json();
    const featMap = {};
    for (const f of allFeatures) featMap[f.idx] = f;

    const meta = allClips[clipIdx];
    if (!meta) {
      document.getElementById('clip-title').textContent = 'Clip not found';
      return;
    }

    const activations = allActivations[String(clipIdx)] || [];

    // Title
    document.getElementById('clip-title').textContent = `Clip ${meta.wav_name}`;
    document.getElementById('crumb-name').textContent = meta.wav_name;

    // Audio player
    const audio = document.querySelector('#clip-player-main audio source');
    audio.src = `audio/${meta.wav_name}`;
    audio.parentElement.load();

    // Meta stats
    const ceti = meta.ceti;
    let cetiStatCards = '';
    if (meta.matched_to_ceti && ceti) {
      cetiStatCards = '<div class="stat-card"><div class="stat-value" style="color:var(--green)">Yes</div><div class="stat-label">CETI matched</div></div>';
      if (ceti.coda_type_label) cetiStatCards += `<div class="stat-card"><div class="stat-value">${ceti.coda_type_label}</div><div class="stat-label">Coda type</div></div>`;
      if (ceti.clan_label) cetiStatCards += `<div class="stat-card"><div class="stat-value">${ceti.clan_label}</div><div class="stat-label">Clan</div></div>`;
    }

    document.getElementById('clip-meta').innerHTML = `
      <div class="stat-card"><div class="stat-value">${meta.n_active_features}</div><div class="stat-label">Active features</div></div>
      <div class="stat-card"><div class="stat-value">${meta.n_clicks || '?'}</div><div class="stat-label">Detected clicks</div></div>
      <div class="stat-card"><div class="stat-value">${meta.duration ? meta.duration.toFixed(2) + 's' : '?'}</div><div class="stat-label">Duration</div></div>
      <div class="stat-card"><div class="stat-value">${meta.f3669_activation ? meta.f3669_activation.toFixed(2) : '0'}</div><div class="stat-label">F3669 activation</div></div>
      ${cetiStatCards}
    `;

    // CETI card
    const cetiCard = document.getElementById('ceti-card');
    cetiCard.style.display = '';
    if (ceti) {
      document.getElementById('ceti-heading').textContent = 'Researcher annotations';
      document.getElementById('ceti-desc').textContent = 'This clip was matched to the CETI labeled sperm whale catalog via ICI pattern similarity.';
      const cetiProps = [];
      if (ceti.coda_type_label) cetiProps.push(['Coda type', ceti.coda_type_label]);
      if (ceti.clan_label) cetiProps.push(['Clan', ceti.clan_label]);
      if (ceti.social_unit) cetiProps.push(['Social unit', 'Unit ' + ceti.social_unit]);
      if (ceti.whale_id && ceti.whale_id !== '0') cetiProps.push(['Whale ID', ceti.whale_id]);
      if (ceti.recording_date) cetiProps.push(['Recording date', ceti.recording_date]);
      if (ceti.catalog_coda_num) cetiProps.push(['Catalog coda number', ceti.catalog_coda_num]);
      if (ceti.n_clicks_catalog) cetiProps.push(['Catalog click count', ceti.n_clicks_catalog]);
      if (ceti.duration_catalog) cetiProps.push(['Catalog duration', ceti.duration_catalog.toFixed(3) + 's']);
      document.getElementById('ceti-props').innerHTML = cetiProps.map(([l, v]) =>
        `<div class="prop-item"><span class="prop-label">${l}</span><span class="prop-value">${v}</span></div>`
      ).join('');
    } else {
      document.getElementById('ceti-heading').textContent = 'CETI catalog status';
      document.getElementById('ceti-desc').textContent = 'This clip was not matched to the CETI labeled sperm whale catalog.';
      document.getElementById('ceti-props').innerHTML = '';
    }

    // Recording props
    const propItems = [];
    if (meta.duration) propItems.push(['Duration', meta.duration.toFixed(3) + 's']);
    if (meta.n_clicks) propItems.push(['Detected clicks', meta.n_clicks]);
    if (meta.mean_ici) propItems.push(['Mean ICI', meta.mean_ici < 0.1 ? (meta.mean_ici * 1000).toFixed(1) + 'ms' : meta.mean_ici.toFixed(4) + 's']);
    if (meta.std_ici) propItems.push(['ICI std dev', meta.std_ici.toFixed(4) + 's']);
    if (meta.cv_ici) propItems.push(['ICI CV', meta.cv_ici.toFixed(2)]);
    if (meta.click_rate_hz) propItems.push(['Click rate', meta.click_rate_hz.toFixed(1) + ' Hz']);
    propItems.push(['ICI biologically plausible', meta.ici_plausible ? 'Yes' : 'No']);
    propItems.push(['CETI catalog match', meta.matched_to_ceti ? 'Yes' : 'No']);
    propItems.push(['Session group', 'WAV ' + (meta.session_group * 50) + '-' + (meta.session_group * 50 + 49)]);
    propItems.push(['WAV number', meta.wav_num]);
    document.getElementById('recording-props').innerHTML = propItems.map(([l, v]) =>
      `<div class="prop-item"><span class="prop-label">${l}</span><span class="prop-value">${v}</span></div>`
    ).join('');

    // Quality flags
    const warnings = [];
    if (meta.suspect_artifact) warnings.push({level: 'warn', text: 'Suspect recording artifact: High F3669 activation combined with biologically implausible click rate.'});
    if (!meta.ici_plausible && meta.mean_ici > 0) warnings.push({level: 'warn', text: `ICI of ${(meta.mean_ici * 1000).toFixed(0)}ms is faster than typical sperm whale coda timing.`});
    if (meta.f3669_activation > 2.0) warnings.push({level: 'warn', text: 'Very high F3669 activation (>2.0) is associated with broadband recording artifacts.'});
    if (meta.matched_to_ceti) warnings.push({level: 'good', text: 'Matched to CETI catalog, confirming recognized sperm whale coda.'});

    if (warnings.length > 0) {
      document.getElementById('warnings-card').style.display = '';
      document.getElementById('warnings-list').innerHTML = warnings.map(w =>
        `<div class="warning-item warning-${w.level}">${w.text}</div>`
      ).join('');
    }

    // Features list
    const maxAct = activations.length > 0 ? activations[0].activation : 1;
    document.getElementById('features-heading').textContent = `Active SAE features (${activations.length})`;

    document.getElementById('features-list').innerHTML = activations.map(act => {
      const feat = featMap[act.idx] || {};
      const interp = interps[String(act.idx)] || {};
      const pct = (act.activation / maxAct * 100).toFixed(0);
      let badges = '';
      if (feat.is_novel) badges += '<span class="clip-badge" style="background:var(--purple)">novel</span>';
      badges += `<span class="clip-badge">${(feat.firing_rate * 100).toFixed(1)}% firing rate</span>`;
      if (interp.rarity) badges += `<span class="clip-badge">${interp.rarity}</span>`;

      return `<div class="clip-row">
        <div class="clip-info" style="flex:1">
          <div class="clip-name-row">
            <a href="feature.html?id=${act.idx}" class="clip-name">F${act.idx}</a>
            <span class="clip-act-value">${act.activation.toFixed(3)}</span>
          </div>
          <div class="clip-act-bar"><div class="clip-act-fill" style="width:${pct}%"></div></div>
          <div class="clip-badges">${badges}</div>
          ${interp.hypothesis ? `<div class="feat-hypothesis">${interp.hypothesis}</div>` : ''}
        </div>
      </div>`;
    }).join('');

    // Nearby clips
    const sg = meta.session_group;
    const nearby = allClips.filter(c => c.session_group === sg && c.clip_idx !== clipIdx).slice(0, 20);
    if (nearby.length > 0) {
      document.getElementById('nearby-card').style.display = '';
      document.getElementById('nearby-list').innerHTML = nearby.map(nc =>
        `<div class="clip-row">
          <div class="clip-info">
            <a href="clip.html?id=${nc.clip_idx}" class="clip-name">${nc.wav_name}</a>
            <span class="clip-badges">
              <span class="clip-badge">${nc.n_active_features} features</span>
              ${nc.f3669_activation > 0 ? `<span class="clip-badge">F3669: ${nc.f3669_activation.toFixed(2)}</span>` : ''}
            </span>
          </div>
          <div class="clip-player">
            <audio controls preload="none"><source src="audio/${nc.wav_name}" type="audio/wav"></audio>
          </div>
        </div>`
      ).join('');
    }
  }

  load();
  </script>
</body>
</html>
